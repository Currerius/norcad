
```{r,setOpts,include=FALSE}
opts_chunk$set(warnings=FALSE,echo=FALSE)
# n.P <- 2; n.M <- 1; n.Surv <- 1
``` 

 - Endpoint: `r sapply( JSON$Endpoints  , with , Label)[n.Surv]`
 - Predictor `r sapply( JSON$Predictors , with , Label)[n.P]`
 - Modifier  `r sapply( JSON$Modifiers  , with , Label)[n.M]`




## `r sapply( JSON$Endpoints , with , Label )[n.Surv]
  `r paste(sapply( JSON$Endpoints , with , Label )[n.Surv]) is observed in `r sum(D$E0 , na.rm = TRUE )` of `r dim(D)[n.Surv]` patients (`r round(100*sum(D$E0 , na.rm = TRUE )/dim(D)[n.Surv] , 1)`%) with a median follow-up time of `r median(D[ , paste("T",n.Surv-1,sep="")],na.rm=TRUE)` days.

  The main endpoint `r paste(sapply( JSON$Endpoints , with , Label )[n.Surv])` followed up until end of 2009 obtained through the Cardiovascular Disease in Norway (CVDNOR) project. CVDNOR is a collaborative project between the University of Bergen and the Norwegian Knowledge Centre for the Health Services. All CVD hospitalisations between 1994 and 2009 were collected retrospectively from the patient administrative systems (PAS) at all somatic hospitals in Norway.
  
  Acknowledgment: The authors thank Tomislav Dimoski at The Norwegian Knowledge Centre for the Health Services, Oslo, Norway for his contribution by developing the software necessary for obtaining data from Norwegian hospitals, conducting the data collection and quality assurance of data in this project.





# `r sapply( JSON$Endpoints , with , Label )[n.Surv]` and `r sapply( JSON$Predictors , with , Label )[n.P]`


## `r sapply( JSON$Endpoints, with , ShortLabel)[n.Surv]` ~ `r sapply( JSON$Predictors, with , ShortLabel)[n.P]`
  
  
```{r,TabCoxSimple,results='asis'}

TabCoxSimple <- rbind(
    cbind(
        OutputHR( alevel = 0 , ptrans = "z" ) ,
        OutputHR( alevel = 1 , ptrans = "z" ) ,
        OutputHR( alevel = 2 , ptrans = "z" )) ,
    cbind(
        OutputHR( alevel = 0 , ptrans = "zlog" ) ,
        OutputHR( alevel = 1 , ptrans = "zlog" ) ,
        OutputHR( alevel = 2 , ptrans = "zlog" )) ,
    cbind(
        OutputHR( alevel = 0 , ptrans = "n4" ) ,
        OutputHR( alevel = 1 , ptrans = "n4" ) ,
        OutputHR( alevel = 2 , ptrans = "n4" )))
        
kable(
    TabCoxSimple ,
    format = "html" ,
    align = "r" ,
    caption = paste(
        "Hazard ratios for association between" ,
        sapply( JSON$Endpoints , with , Label )[n.Surv] ,
        "and" , 
        sapply( JSON$Predictors , with , Label )[n.P] ,
        "estimated with Cox proportional hazards models; adjustment 1 for" , 
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ') ,
        "; adjustment 2 additionally for" , 
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==2] , collapse = ', ') ,
        ".")
    )

``` 





# Interaction: `r sapply( JSON$Predictors , with , ShortLabel )[n.P]` x `r sapply( JSON$Modifiers , with ,ShortLabel )[n.M]`


## `r sapply( JSON$Endpoints , with , ShortLabel )[n.Surv]` and `r sapply( JSON$Predictors , with , ShortLabel )[n.P]` in subgroups of high/low `r sapply( JSON$Modifiers , with , ShortLabel )[n.M]`

      
```{r,TabCoxSubgroup,results='asis'}

TabCoxSubgroup <- rbind(
        PrintCoxSubgroupTable( alevel = 0 , ptrans = "z" ) ,
        PrintCoxSubgroupTable( alevel = 0 , ptrans = "zlog" ) ,
        PrintCoxSubgroupTable( alevel = 0 , ptrans = "n4" ) ,
        PrintCoxSubgroupTable( alevel = 1 , ptrans = "z" ) ,
        PrintCoxSubgroupTable( alevel = 1 , ptrans = "zlog" ) ,
        PrintCoxSubgroupTable( alevel = 1 , ptrans = "n4" ) ,
        PrintCoxSubgroupTable( alevel = 2 , ptrans = "z" ) ,
        PrintCoxSubgroupTable( alevel = 2 , ptrans = "zlog" ) ,
        PrintCoxSubgroupTable( alevel = 2 , ptrans = "n4" ))
        
        
kable(
    TabCoxSubgroup ,
    format = "html" ,
    align = "r" ,
    caption = paste(
        "Hazard ratios for association between" ,
        sapply( JSON$Endpoints , with , Label )[n.Surv] ,
        "and" ,
        sapply( JSON$Predictors , with , Label )[n.P] ,
        "in subgroups of high vs. low levels of" ,
        sapply( JSON$Modifiers , with , Label )[n.M] ,
        "estimated with Cox proportional hazards models; adjustment 1 for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ') ,
        "; adjustment 2 additionally  for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==2] , collapse = ', ') ,
        ". The effect modifier" ,
        sapply( JSON$Modifiers , with , Label )[n.M] ,
        "is divided into high/low levels according to the population median of" ,
        signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3))
    )

        
``` 



## `r sapply( JSON$Endpoints , with , ShortLabel )[n.Surv]` and `r sapply( JSON$Predictors , with , ShortLabel )[n.P]` and interaction with high/low `r sapply( JSON$Modifiers , with , ShortLabel )[n.M]`

      
```{r,TabCoxInteraction,results='asis'}

TabzCoxInteraction <- rbind(
    cbind(
        OutputHR( alevel = 0 , ptrans = "z" , mtrans = "c2" ) ,
        OutputHR( alevel = 1 , ptrans = "z" , mtrans = "c2" ) ,
        OutputHR( alevel = 2 , ptrans = "z" , mtrans = "c2" )))

TabzlogCoxInteraction <- rbind(
    cbind(
        OutputHR( alevel = 0 , ptrans = "zlog" , mtrans = "c2" ) ,
        OutputHR( alevel = 1 , ptrans = "zlog" , mtrans = "c2" ) ,
        OutputHR( alevel = 2 , ptrans = "zlog" , mtrans = "c2" )))
        
Tabn4CoxInteraction <- rbind(
    cbind(
        OutputHR( alevel = 0 , ptrans = "n4" , mtrans = "c2" ) ,
        OutputHR( alevel = 1 , ptrans = "n4" , mtrans = "c2" ) ,
        OutputHR( alevel = 2 , ptrans = "n4" , mtrans = "c2" )))

        
kable(
    x = TabzCoxInteraction ,
    align = "r" ,
    format = "html" ,
    caption = paste(
        "Hazard ratios for association between" ,
        sapply( JSON$Endpoints , with , Label )[1] ,
        "and SD increase in" ,
        sapply( JSON$Predictors , with , Label )[1] ,
        "and effect modification by high vs low levels of" ,
        sapply( JSON$Modifiers , with , Label )[1] ,
        "( divided into high/low levels according to the population median of" ,
        signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3) ,
        ")  estimated with Cox proportional hazards models; adjustment 1 for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ') ,
        "; adjustment 2 additionally  for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==2] , collapse = ', ') ,
        "."
        ))

kable(
    x = TabzlogCoxInteraction ,
    align = "r" ,
    format = "html" ,
    caption = paste(
        "Hazard ratios for association between" ,
        sapply( JSON$Endpoints , with , Label )[1] ,
        "and SD increase in log-transformed" ,
        sapply( JSON$Predictors , with , Label )[1] ,
        "and effect modification by high vs low levels of" ,
        sapply( JSON$Modifiers , with , Label )[1] ,
        "( divided into high/low levels according to the population median of" ,
        signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3) ,
        ")  estimated with Cox proportional hazards models; adjustment 1 for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ') ,
        "; adjustment 2 additionally  for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==2] , collapse = ', ') ,
        "."
        ))

        
kable(
    x = TabzCoxInteraction ,
    align = "r" ,
    format = "html" ,
    caption = paste(
        "Hazard ratios for association between" ,
        sapply( JSON$Endpoints , with , Label )[1] ,
        "and quartile increase in" ,
        sapply( JSON$Predictors , with , Label )[1] ,
        "and effect modification by high vs low levels of" ,
        sapply( JSON$Modifiers , with , Label )[1] ,
        "( divided into high/low levels according to the population median of" ,
        signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3) ,
        ")  estimated with Cox proportional hazards models; adjustment 1 for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ') ,
        "; adjustment 2 additionally  for" ,
        paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==2] , collapse = ', ') ,
        "."
        ))

``` 



## GAM plot percentiles (ranked)

Smoothing spline estimates of `r sapply( JSON$Endpoints , with , Label )[n.Surv]` hazard by percentiles of `r sapply( JSON$Predictors , with , Label )[n.P]` in subgroups of high vs. low levels of `r sapply( JSON$Modifiers , with , Label )[n.M]` estimated with Cox proportional hazards models adjusted for `r paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ')`. The effect modifier `r sapply( JSON$Modifiers , with , Label )[n.M]` is divided into high/low levels according to the population median of `r signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3)`.
              
```{r,CoxGAMqSubgroups,fig.width=16,fig.height=8,out.width="4in"}
i.Low <- which(D[ , paste( "n2M" , n.M-1 , sep = "" ) ] == 1 )
i.High <- which(D[ , paste( "n2M" , n.M-1 , sep = "" ) ] == 2 )

F <- as.formula(
    paste(
        "Surv" , n.Surv-1 ,
        "~pspline(qP" , n.P-1 , ")+" ,
        paste0( As[ which(nLevels==1) ] , collapse="+" ) ,
        sep = ""
    )
)

par( mfcol = c(1,2) , las = 1 )

termplot(
    model = coxph(
        formula = F ,
        data = D[i.Low,] ) ,
    terms = 1 ,
    se = TRUE ,
    main = paste( "Low" , sapply( JSON$Modifiers , with , Label )[n.M]) ,
    xlabs = paste( "Percentiles of" , sapply( JSON$Predictors , with , Label )[n.P]) ,
    ylabs = "Partial log-hazard"
)

termplot(
    model = coxph(
        formula = F ,
        data = D[i.High,] ) ,
    terms = 1 ,
    se = TRUE ,
    main = paste( "High" , sapply( JSON$Modifiers , with , Label )[n.M]) ,
    xlabs = paste( "Percentiles of" , sapply( JSON$Predictors , with , Label )[n.P]) ,
    ylabs = "Partial log-hazard"
)

``` 




## GAM plot log transformed normalized
    
```{r,CoxGAMzlogSubgroups,fig.width=16,fig.height=8,out.width="4in"}

i.Low <- which(D[ , paste( "n2M" , n.M-1 , sep = "" ) ] == 1 )
i.High <- which(D[ , paste( "n2M" , n.M-1 , sep = "" ) ] == 2 )

F <- as.formula(
    paste(
        "Surv" , n.Surv-1 ,
        "~pspline(zlogP" , n.P-1 , ")+" ,
        paste0( As[ which(nLevels==1) ] , collapse="+" ) ,
        sep = ""
    )
)

par( mfcol = c(1,2) , las = 1 )

termplot(
    model = coxph(
        formula = F ,
        data = D[i.Low,] ) ,
    terms = 1 ,
    se = TRUE ,
    main = paste( "Low" , sapply( JSON$Modifiers , with , Label )[n.M]) ,
    xlabs = paste( "SD log -" , sapply( JSON$Predictors , with , Label )[n.P]) ,
    ylabs = "Partial log-hazard"
)

termplot(
    model = coxph(
        formula = F ,
        data = D[i.High,] ) ,
    terms = 1 ,
    se = TRUE ,
    main = paste( "High" , sapply( JSON$Modifiers , with , Label )[n.M]) ,
    xlabs = paste( "SD log -" , sapply( JSON$Predictors , with , Label )[n.P]) ,
    ylabs = "Partial log-hazard"
)

``` 
    
Smoothing spline estimates of `r sapply( JSON$Endpoints , with , Label )[n.Surv]` hazard by SD of log-transformed `r sapply( JSON$Predictors , with , Label )[n.P]` in subgroups of high vs. low levels of `r sapply( JSON$Modifiers , with , Label )[n.M]` estimated with Cox proportional hazards models adjusted for `r paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ')`. The effect modifier `r sapply( JSON$Modifiers , with , Label )[n.M]` is divided into high/low levels according to the population median of `r signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3)`.







## GAM plot percentiles (ranked)
              
```{r,CoxSmoothSubgroupsq,fig.width=8,fig.height=8,out.width="3in"}

PlotCoxSmoothSubgroups(
    ptrans = "q" ,
    alevel = 1 ,
    xlab = paste("Percentiles of" , sapply( JSON$Predictors , with , Label )[n.P])
)

``` 
    
Smoothing spline estimates of `r sapply( JSON$Endpoints , with , Label )[n.Surv]` hazard by percentiles of `r sapply( JSON$Predictors , with , Label )[n.P]` in subgroups of high vs. low levels of `r sapply( JSON$Modifiers , with , Label )[n.M]` estimated with Cox proportional hazards models adjusted for `r paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ')`. The effect modifier `r sapply( JSON$Modifiers , with , Label )[n.M]` is divided into high/low levels according to the population median of `r signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3)`.





## GAM plot normalized logarithm

```{r,CoxSmoothSubgroupszlog,fig.width=8,fig.height=8,out.width="3in"}

PlotCoxSmoothSubgroups(
    ptrans = "zlog" ,
    alevel = 1 ,
    xlab = paste("SD of log-transformed" , sapply( JSON$Predictors , with , Label )[n.P])
)

``` 
    
Smoothing spline estimates of `r sapply( JSON$Endpoints , with , Label )[n.Surv]` hazard by SD of log-transformed `r sapply( JSON$Predictors , with , Label )[n.P]` in subgroups of high vs. low levels of `r sapply( JSON$Modifiers , with , Label )[n.M]` estimated with Cox proportional hazards models adjusted for `r paste0( sapply( JSON$Adjustments , with , Label )[sapply( JSON$Adjustments , with , Level )==1] , collapse = ', ')`. The effect modifier `r sapply( JSON$Modifiers , with , Label )[n.M]` is divided into high/low levels according to the population median of `r signif( median( D[ , paste( "M" , n.M-1 , sep = "" ) ] , na.rm = TRUE ),3)`.









## 3d-GAM

```{r,VisGAMq,fig.width=8,fig.height=8,out.width="3in"}

F <- as.formula( paste( "E" , n.Surv-1 , "~s(qP" , n.P-1 , ",qM" , n.M-1 , ")" , sep = "" ))

GAM <- gam(
    formula = F ,
    data = D ,
    family = "binomial")

vis.gam(
    x = GAM ,
    n.grid = 50 ,
    color = "terrain" ,
    type = "response" ,
    xlab = sapply( JSON$Predictors , with , Label )[n.P] ,
    ylab = sapply( JSON$Modifiers , with , Label )[n.M] ,
    zlab = "Incidence" ,
    phi = 0 ,
    theta = -20 ,
    ticktype = "detailed"
)
    
``` 
    
Surface spline of `r sapply( JSON$Endpoints , with , Label )[n.Surv]` incidence by empirical percentiles of `r sapply( JSON$Predictors , with , Label )[n.P]` and `r sapply( JSON$Modifiers , with , Label )[n.M]` estimated with a Generalized Additve Model.




## 3d-GAM with SE
      
```{r,VisGAMqSE,fig.width=8,fig.height=8,out.width="3in"}

vis.gam(
    x = GAM ,
    n.grid = 50 ,
    se = TRUE ,
    type = "response" ,
    xlab = sapply( JSON$Predictors , with , Label )[1] ,
    ylab = sapply( JSON$Modifiers , with , Label )[1] ,
    zlab = "Incidence" ,
    phi = 0 ,
    theta = -20 ,
    ticktype = "detailed"
)
    
``` 
    
Surface spline of `r sapply( JSON$Endpoints , with , Label )[n.Surv]` incidence by empirical percentiles of `r sapply( JSON$Predictors , with , Label )[n.P]` and `r sapply( JSON$Modifiers , with , Label )[n.M]` estimated with a Generalized Additve Model; coloured grids depict 95\% confidence levels.

